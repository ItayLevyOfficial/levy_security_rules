service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{phone_number} {

      function validName(name) {
        return name is string &&
          name.size() > 0 &&
          name.size() < 50;
      }

      function verified_phone_number() {
        return phone_number == request.auth.token.phone_number;
      }

      match /sent_messages/{message_id} {
        allow write: if verified_phone_number();
      }

      allow write: if 
        verified_phone_number() &&
        validName(request.resource.data.name);

      allow delete: if verified_phone_number();
      allow read: if verified_phone_number();
    }
  }
}
